#!/usr/bin/env bash
# Build all user libraries and solvers for this project.
# Usage:
#   ./Allwmake                 # auto-detect cores
#   ./Allwmake -j 8            # specify parallel jobs
#   NPROCS=8 ./Allwmake        # env override

set -euo pipefail

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
NPROCS="${NPROCS:-}"
while getopts ":j:" opt; do
  case $opt in
    j) NPROCS="$OPTARG" ;;
    *) echo "Usage: $0 [-j N]"; exit 1 ;;
  esac
done

if [[ -z "${NPROCS}" ]]; then
  if command -v nproc >/dev/null 2>&1; then
    NPROCS="$(nproc)"
  else
    NPROCS=4
  fi
fi

echo "[Allwmake] Using -j${NPROCS}"

# Build libraries first
( cd "$SCRIPT_DIR/libraries" && ./Allwmake -j "${NPROCS}" )

# Build solvers
( cd "$SCRIPT_DIR/applications/solvers/compressible/rhoHyperFoam" && ./Allwmake -j "${NPROCS}" )

echo "[Allwmake] Done."
